<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mixue Chat - Frontend</title>
  <style>
    :root{
      --bg:#f3f8ff;
      --card:#ffffff;
      --accent:#00a4ff;
      --muted:#6b7280;
      --sent:#dcf8c6;
      --recv:#ffffff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#0f172a}
    .app{max-width:1000px;margin:24px auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7ed6ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{margin:0;font-size:20px}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px}

    /* Left column (menu + info) */
    .left{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .menu-title{font-weight:600;margin-bottom:8px}
    .menu-list{list-style:none;padding:0;margin:0}
    .menu-item{display:flex;justify-content:space-between;padding:8px 10px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,#ffffff,#fbfdff);cursor:pointer}
    .menu-item:hover{box-shadow:0 6px 12px rgba(2,6,23,0.04)}
    .menu-tag{font-size:12px;color:var(--muted)}
    .quick-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}

    /* Right column (chat) */
    .chat-card{background:var(--card);border-radius:12px;padding:14px;display:flex;flex-direction:column;height:640px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .chat-window{flex:1;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg,#f9fbff,#f7fbff)}
    .msg{max-width:70%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.35}
    .msg.assistant{background:var(--recv);align-self:flex-start}
    .msg.user{background:var(--sent);align-self:flex-end}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}

    .composer{display:flex;gap:8px;margin-top:12px}
    .composer input[type=text]{flex:1;padding:12px;border-radius:10px;border:1px solid #e6eefb;font-size:15px}
    .composer button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
    .composer button[disabled]{opacity:0.6;cursor:default}

    .session-info{font-size:13px;color:var(--muted);margin-top:8px}

    /* mobile */
    @media(max-width:880px){
      .layout{grid-template-columns:1fr;}
      .left{order:2}
      .chat-card{order:1;height:560px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">MX</div>
      <div>
        <h1>Mixue - Trò chuyện và đặt hàng</h1>
        <div style="color:var(--muted);font-size:13px">Kết nối tới API: <strong>http://localhost:8000/chat</strong></div>
      </div>
    </header>

    <div class="layout">
      <aside class="left">
        <div class="menu-title">Menu nổi bật</div>
        <ul class="menu-list" id="menuList">
          <!-- items injected by JS -->
        </ul>

        <div class="menu-title" style="margin-top:10px">Hành động nhanh</div>
        <div class="quick-actions">
          <div class="chip" data-cmd="Giới thiệu menu">Giới thiệu menu</div>
          <div class="chip" data-cmd="Tôi muốn đặt hàng">Đặt hàng</div>
          <div class="chip" data-cmd="Mẹo chọn món">Mẹo chọn món</div>
        </div>

        <div class="menu-title" style="margin-top:12px">Lưu ý</div>
        <div style="font-size:13px;color:var(--muted)">Bot sẽ yêu cầu tên, điện thoại, loại đơn hàng trước khi lưu.</div>

      </aside>

      <main class="chat-card">
        <div class="chat-window" id="chatWindow" aria-live="polite"></div>

        <div class="composer">
          <input id="inputMessage" type="text" placeholder="Gõ tin nhắn hoặc click món để thêm..." />
          <button id="sendBtn">Gửi</button>
        </div>
        <div class="session-info" id="sessionInfo"></div>
      </main>
    </div>
  </div>

  <script>
    // ====== cấu hình ======
    const API_URL = 'http://localhost:8000/chat'; // sửa nếu API chạy ở địa chỉ khác
    const SESSION_KEY = 'mixue_chat_session';

    const menuData = [
      {id:1, name:'Kem ốc quế', price:'10k', tag:'Must Try'},
      {id:2, name:'Super sundae trân châu đường đen', price:'25k', tag:'Must Try'},
      {id:3, name:'Sữa kem lắc dâu tây', price:'25k', tag:'Best Seller'},
      {id:4, name:'Hồng trà kem', price:'25k'},
      {id:5, name:'Nước chanh tươi lạnh', price:'20k', tag:'Must Try'},
      {id:6, name:'Dương chi cam lộ', price:'35k'},
      {id:7, name:'Trà sữa trân châu đường đen', price:'25k'},
      {id:8, name:'Trà Đào Bốn Mùa', price:'25k', tag:'Must Try'},
      {id:9, name:'Hồng trà vải', price:'25k'}
    ];

    // UI Refs
    const menuList = document.getElementById('menuList');
    const chatWindow = document.getElementById('chatWindow');
    const sendBtn = document.getElementById('sendBtn');
    const inputMessage = document.getElementById('inputMessage');
    const sessionInfo = document.getElementById('sessionInfo');

    // init menu
    function renderMenu(){
      menuList.innerHTML = '';
      menuData.forEach(item => {
        const li = document.createElement('li');
        li.className = 'menu-item';
        li.innerHTML = `<div><strong>${item.name}</strong><div class=\"menu-tag\">${item.tag||''}</div></div><div>${item.price}</div>`;
        li.addEventListener('click', ()=> onMenuClick(item));
        menuList.appendChild(li);
      });
    }

    function onMenuClick(item){
      appendMessage('user', `${item.name} - ${item.price}`);
      sendMessage(`${item.name}`);
    }

    // session management
    function getSession(){
      return localStorage.getItem(SESSION_KEY);
    }
    function setSession(s){
      if(!s) return;
      localStorage.setItem(SESSION_KEY, s);
      updateSessionInfo();
    }
    function updateSessionInfo(){
      const s = getSession();
      sessionInfo.textContent = s ? `session: ${s}` : 'Chưa có session - sẽ tạo mới khi gửi tin nhắn.';
    }

    // chat UI helpers
    function appendMessage(role, text){
      const msg = document.createElement('div');
      msg.className = 'msg ' + (role==='user' ? 'user' : 'assistant');
      msg.innerHTML = `<div>${escapeHtml(text)}</div>`;
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function setTyping(on=true){
      const id = 'typing-indicator';
      let el = document.getElementById(id);
      if(on){
        if(!el){
          el = document.createElement('div');
          el.id = id; el.className='msg assistant'; el.innerHTML='<em>Đang nhập...</em>';
          chatWindow.appendChild(el);
        }
      } else {
        if(el) el.remove();
      }
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function escapeHtml(unsafe){
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // send message to backend
    async function sendMessage(text){
      if(!text || !text.trim()) return;
      inputMessage.value = '';
      sendBtn.disabled = true;
      setTyping(true);

      const payload = { message: text };
      const session_uuid = getSession();
      if(session_uuid) payload.session_uuid = session_uuid;

      try{
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('HTTP error ' + res.status);
        const data = await res.json();
        setTyping(false);
        if(data && data.response){
          appendMessage('assistant', data.response);
        }
        if(data && data.session_uuid){
          setSession(data.session_uuid);
        }
      }catch(err){
        setTyping(false);
        appendMessage('assistant', 'Có lỗi khi kết nối tới server: ' + err.message);
        console.error(err);
      }finally{
        sendBtn.disabled = false;
      }
    }

    // wire events
    sendBtn.addEventListener('click', ()=>{
      const t = inputMessage.value.trim();
      if(!t) return;
      appendMessage('user', t);
      sendMessage(t);
    });

    inputMessage.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendBtn.click();
      }
    });

    document.querySelectorAll('.chip').forEach(c=>c.addEventListener('click', ()=>{
      const cmd = c.dataset.cmd;
      appendMessage('user', cmd);
      sendMessage(cmd);
    }));

    // initial
    renderMenu();
    updateSessionInfo();

    // Optional: welcome message from assistant to trigger menu intro
    window.addEventListener('load', ()=>{
      appendMessage('assistant', 'Xin chào! Mình là nhân viên order Mixue. Mình có thể giới thiệu menu hoặc giúp bạn đặt hàng.');
      // Don't call API immediately; user interacts first. If you want auto intro from backend, uncomment below
      // sendMessage('Giới thiệu menu');
    });
  </script>
</body>
</html>